# Phase 3-1: Python数据处理基础（Pandas/NumPy概念）

## 一、概念定义

### 1.1 NumPy（Numerical Python）
NumPy是Python科学计算的基础库，提供高性能的多维数组对象（ndarray）和用于处理这些数组的工具。

**核心特性：**
- **ndarray**：N维数组对象，是NumPy的核心数据结构
- **向量化运算**：避免Python循环，利用C语言实现高效计算
- **广播机制**：不同形状数组之间的算术运算规则
- **通用函数（ufunc）**：对数组进行元素级运算的函数

### 1.2 Pandas
Pandas是基于NumPy构建的数据分析和处理库，提供了高效、灵活的数据结构。

**核心数据结构：**
- **Series**：一维带标签数组，类似字典+数组的混合体
- **DataFrame**：二维表格型数据结构，类似Excel或SQL表
- **Index**：轴标签，支持层级索引（MultiIndex）

---

## 二、算法原理

### 2.1 NumPy核心原理

#### 内存布局与性能
```
NumPy数组 vs Python列表：
- NumPy数组：连续内存块，同类型元素，缓存友好
- Python列表：指针数组，分散存储，类型不固定
- 性能差距：通常10-100倍
```

#### 向量化计算原理
```
传统Python循环：逐个元素处理，每次迭代Python解释器开销
NumPy向量化：底层C/Fortran实现，SIMD指令并行处理
```

#### 广播（Broadcasting）规则
1. 维度从后向前对齐
2. 对应维度相等，或其中一个为1
3. 缺失维度视为1

### 2.2 Pandas核心原理

#### 数据对齐机制
- 基于标签的自动对齐，而非位置索引
- 运算时自动匹配相同标签的数据
- 缺失标签产生NaN（Not a Number）

#### 索引系统
```
单级索引：单一维度标签
多级索引（MultiIndex）：层次化标签，支持高维数据表示
```

#### 数据类型处理
- 自动推断数据类型
- 支持分类数据（Categorical）
- 可空整数/布尔类型（Int64, boolean）

---

## 三、应用场景

### 3.1 金融数据处理场景

| 场景 | NumPy适用 | Pandas适用 |
|------|-----------|------------|
| 价格序列计算收益率 | ✓ 向量化运算 | ✓ time series操作 |
| 多股票数据管理 | - | ✓ DataFrame表格管理 |
| 矩阵运算（协方差） | ✓ 线性代数模块 | - |
| 数据清洗与合并 | - | ✓ 强大的缺失值处理 |
| 时间序列重采样 | - | ✓ resample方法 |
| 滚动窗口计算 | ✓ stride tricks | ✓ rolling方法 |

### 3.2 量化投资典型应用

**收益率计算**
- 简单收益率：$R_t = \frac{P_t - P_{t-1}}{P_{t-1}}$
- 对数收益率：$r_t = \ln(P_t) - \ln(P_{t-1})$
- NumPy向量化实现高效批量计算

**风险指标计算**
- 波动率：收益率的标准差
- 相关系数矩阵：np.corrcoef
- 协方差矩阵：np.cov

**数据预处理**
- 缺失值处理：填充、插值、删除
- 异常值检测：基于统计阈值
- 数据标准化：z-score标准化

---

## 四、注意事项

### 4.1 性能优化

**避免的操作**
```
❌ 在大DataFrame上使用iterrows()循环
❌ 频繁的类型转换
❌ 逐行append构建DataFrame
❌ 在循环中重复查询同一数据
```

**推荐的做法**
```
✓ 使用向量化操作替代循环
✓ 使用loc/iloc进行索引而非链式索引
✓ 预分配内存，批量操作
✓ 使用category类型处理重复字符串
✓ 使用eval/query优化复杂运算
```

### 4.2 数据类型陷阱

| 问题 | 说明 | 解决方案 |
|------|------|----------|
| 整数溢出 | NumPy整数有固定范围 | 使用Python int或检查范围 |
| NaN传播 | 任何数与NaN运算结果为NaN | 使用fillna或nan-aware函数 |
| 浮点精度 | 二进制浮点表示误差 | 使用decimal模块或容差比较 |
| 时间戳精度 | 纳秒级存储限制 | 注意时间范围限制 |

### 4.3 内存管理

**内存优化技巧**
- 使用astype()转换到更小的数据类型
- 删除中间变量：del df; gc.collect()
- 使用chunksize分块读取大文件
- 使用内存映射处理超大数据

### 4.4 量化投资特殊注意

**数据质量**
- 股价数据需处理除权除息
- 注意停牌日的缺失数据
- 时间序列数据确保时区一致
- 高频数据注意时间戳精度

**计算精度**
- 收益率累加使用对数收益率避免路径依赖
- 夏普比率计算注意年化因子选择
- 避免在循环中进行浮点累加

---

## 五、核心概念总结

```
┌─────────────────────────────────────────────────────┐
│              Python数据处理技术栈                    │
├─────────────────────────────────────────────────────┤
│  NumPy（底层）                                       │
│  ├── 高性能数组运算                                  │
│  ├── 数学/统计/线性代数函数                         │
│  └── 随机数生成                                      │
├─────────────────────────────────────────────────────┤
│  Pandas（上层）                                      │
│  ├── 结构化数据管理（DataFrame）                     │
│  ├── 时间序列处理                                    │
│  ├── 数据清洗与转换                                  │
│  └── 数据聚合与分组                                  │
├─────────────────────────────────────────────────────┤
│  金融应用                                            │
│  ├── 收益率/风险指标计算                             │
│  ├── 因子数据处理                                    │
│  ├── 回测数据准备                                    │
│  └── 实时数据流处理                                  │
└─────────────────────────────────────────────────────┘
```

---

*文档创建时间：2026-02-24*  
*所属阶段：Phase 3 - 量化技能（第1/20项）*
