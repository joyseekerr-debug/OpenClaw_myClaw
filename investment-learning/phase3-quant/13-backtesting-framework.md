# Phase 3-13: 回测框架设计

## 一、概念定义

### 1.1 回测（Backtesting）
在历史数据上模拟策略的交易过程，评估策略在过去表现的方法。

**核心目的：**
- **策略验证**：检验策略逻辑是否正确
- **业绩评估**：量化策略历史表现
- **风险识别**：发现潜在风险点
- **参数优化**：寻找最优参数组合
- **信心建立**：实盘前建立信心

**回测的局限：**
```
"回测表现 ≠ 实盘表现"

常见偏差：
• 过度拟合历史数据
• 未考虑市场冲击和滑点
• 未考虑流动性限制
• 市场环境可能改变
```

### 1.2 回测框架组成

```
┌─────────────────────────────────────────────────────────┐
│                  回测框架架构                            │
├─────────────────────────────────────────────────────────┤
│  数据层（Data Layer）                                    │
│  ├── 行情数据：价格、成交量、复权因子                   │
│  ├── 基本面数据：财务指标、公告事件                     │
│  └── 参考数据：成分股、行业分类、交易日历               │
├─────────────────────────────────────────────────────────┤
│  策略层（Strategy Layer）                                │
│  ├── 信号生成：买入/卖出信号逻辑                        │
│  ├── 仓位管理：资金分配、仓位控制                       │
│  └── 风险控制：止损、止盈、仓位限制                     │
├─────────────────────────────────────────────────────────┤
│  执行层（Execution Layer）                               │
│  ├── 订单类型：市价/限价/止损                           │
│  ├── 成交模拟：滑点、冲击成本、部分成交                 │
│  └── 费用计算：佣金、印花税、融资利息                   │
├─────────────────────────────────────────────────────────┤
│  账户层（Account Layer）                                 │
│  ├── 持仓管理：股票数量、成本价、市值                   │
│  ├── 资金管理：可用资金、冻结资金、总资产               │
│  └── 盈亏计算：实现盈亏、浮动盈亏                       │
├─────────────────────────────────────────────────────────┤
│  分析层（Analytics Layer）                               │
│  ├── 收益指标：收益率、夏普比率、最大回撤               │
│  ├── 风险指标：波动率、VaR、下行风险                    │
│  └── 交易分析：胜率、盈亏比、换手率                     │
└─────────────────────────────────────────────────────────┘
```

### 1.3 回测类型

**事件驱动回测（Event-Driven）**
```
原理：
• 模拟真实交易流程
• 按时间顺序处理市场事件
• 触发策略响应

事件类型：
• 市场数据事件（价格更新）
• 信号事件（策略产生交易信号）
• 订单事件（下单）
• 成交事件（订单成交）
• 定时事件（日终结算）

优点：
• 最接近实盘
• 可模拟复杂逻辑
• 易于扩展

缺点：
• 速度慢
• 实现复杂
```

**向量化回测（Vectorized）**
```
原理：
• 使用矩阵运算批量计算
• 一次性处理整个时间序列
• 假设在时点T已知所有信息

优点：
• 速度快（10-100倍）
• 实现简单
• 适合快速验证想法

缺点：
• 难以模拟复杂执行逻辑
• 容易引入前视偏差
• 无法精细模拟成交
```

---

## 二、算法原理

### 2.1 数据处理流程

**数据对齐**
```
关键原则：
• 所有数据必须时点一致
• 只用当前时点及之前的数据
• 处理停牌、除权除息

实现要点：
• 使用交易日历统一时间轴
• 缺失数据标记而非填充
• 复权价格保持连续性
```

**前视偏差防护**
```
防护措施：
1. 数据时间戳严格管理
   • 收盘价T日收盘后才可获得
   • T+1日才能用于决策
   
2. 财务数据处理
   • 财报发布日 ≠ 报告期结束日
   • 使用发布后的第一个交易日数据
   
3. 复权因子处理
   • 使用当时的复权因子
   • 不使用未来调整的复权因子

4. 成分股处理
   • 使用历史成分股
   • 避免幸存者偏差
```

### 2.2 订单执行模型

**成交价格模型**
```
理想化假设（不推荐）：
• 按收盘价成交
• 无滑点
• 无限流动性

实际模型：
• 限价单：按指定价格或更好价格
• 市价单：按下一成交价（考虑滑点）
• VWAP：按成交量加权平均价

滑点模型：
• 固定滑点：成交价 ± 固定跳数
• 比例滑点：成交价 × (1 ± 比例)
• 波动率相关：滑点 ∝ 波动率
• 成交量相关：滑点 ∝ 1/成交量
```

**冲击成本模型**
```
线性模型：
冲击成本 = k × 订单规模 / 日均成交量

非线性模型（更实际）：
冲击成本 = k × (订单规模 / 日均成交量)^α
其中 α ≈ 0.6（平方根法则）

影响因素：
• 订单规模
• 股票流动性
• 市场波动率
• 交易时段
```

### 2.3 账户结算逻辑

**每日结算流程**
```
开盘前：
• 检查持仓状态
• 处理停牌、退市
• 更新可用资金

盘中：
• 监控订单状态
• 处理成交回报
• 更新持仓和资金

收盘后：
• 计算当日盈亏
• 计算市值
• 更新历史记录
• 生成对账单
```

**费用计算**
```
交易费用：
• 佣金：成交金额 × 佣金率（最低5元）
• 印花税：卖出金额 × 0.1%（仅A股卖出）
• 过户费：成交股数 × 费率
• 经手费、证管费

资金成本：
• 融资利息：融资额 × 利率 × 天数
• 融券费用：融券市值 × 费率

其他：
• 分红送股处理
• 配股、增发处理
```

### 2.4 并行回测

**多进程回测**
```
适用场景：
• 多参数组合测试
• 多策略比较
• 蒙特卡洛模拟

实现方式：
• 每个进程独立回测
• 共享数据（只读）
• 聚合结果

注意：
• 内存管理
• 进程间通信开销
• 随机种子设置
```

---

## 三、应用场景

### 3.1 策略开发流程

```
1. 想法验证（向量化回测）
   • 快速实现
   • 验证核心逻辑
   • 初步评估收益

2. 精细回测（事件驱动）
   • 精确模拟执行
   • 考虑交易成本
   • 识别实现难点

3. 参数优化
   • 网格搜索
   •  walk-forward优化
   • 避免过拟合

4. 稳健性检验
   • 不同市场环境
   • 参数敏感性分析
   • 压力测试

5. 实盘模拟（Paper Trading）
   • 实时数据
   • 模拟执行
   • 最终验证
```

### 3.2 参数优化方法

**网格搜索（Grid Search）**
```
方法：
• 定义参数网格
• 遍历所有组合
• 选择最优参数

注意：
• 避免在测试集上调参
• 使用验证集或交叉验证
• 考虑计算成本
```

**随机搜索（Random Search）**
```
方法：
• 在参数空间随机采样
• 通常比网格搜索更高效
• 适合高维参数空间
```

**Walk-Forward优化**
```
方法：
• 滚动窗口优化
• 训练期优化参数
• 测试期验证
• 前向推进

优点：
• 避免前视偏差
• 模拟实盘使用方式
• 评估参数稳定性
```

### 3.3 回测分析维度

**收益分析**
```
指标：
• 年化收益率
• 累计收益率
• 超额收益率（vs基准）
• 月度/年度胜率

可视化：
• 收益曲线
• 回撤曲线
• 月度收益热力图
```

**风险分析**
```
指标：
• 年化波动率
• 最大回撤及持续时间
• VaR（风险价值）
• CVaR（条件风险价值）
• 下行标准差

分析：
• 回撤恢复时间
• 极端事件影响
• 尾部风险
```

**交易分析**
```
指标：
• 总交易次数
• 胜率（盈利交易占比）
• 盈亏比（平均盈利/平均亏损）
• 持仓周期分布
• 换手率

分析：
• 交易时间分布
• 不同市场状态下的表现
• 交易成本占比
```

---

## 四、注意事项

### 4.1 常见回测陷阱

**前视偏差（Look-ahead Bias）**
```
❌ 使用收盘价信号，当天成交
❌ 财报发布前使用财报数据
❌ 全样本标准化
❌ 事后选择成分股

✅ 使用下一周期开盘价成交
✅ 财报发布后的数据才使用
✅ 滚动窗口标准化
✅ 使用历史成分股
```

**幸存者偏差（Survivorship Bias）**
```
❌ 只用当前成分股历史数据
❌ 忽略退市、破产公司
❌ 基金只用现存基金

✅ 获取完整历史成分股
✅ 包含退市股票数据
✅ 记录成分股变更事件
```

**过拟合（Overfitting）**
```
表现：
• 回测收益极高
• 参数过于精确
• 只在特定时期有效

防范：
• 样本外测试
• 交叉验证
• 简化策略
• 增加交易成本假设
```

### 4.2 成本与滑点

**低估交易成本**
```
实际成本包括：
• 显性成本：佣金、印花税
• 隐性成本：滑点、冲击成本
• 机会成本：未成交的潜在收益

建议：
• 保守估计滑点
• 大容量策略增加冲击成本
• 考虑流动性限制
```

**流动性假设**
```
❌ 假设可以无限量成交
❌ 忽略涨跌停限制
❌ 忽略停牌

✅ 设置单票最大持仓比例
✅ 考虑日均成交量限制
✅ 处理涨跌停无法成交
✅ 停牌期间无法交易
```

### 4.3 回测与实盘差异

**实盘额外挑战**
```
技术层面：
• 系统延迟
• 网络中断
• 数据异常
• 系统故障

市场层面：
• 流动性变化
• 市场冲击
• 监管变化
• 突发事件

操作层面：
• 执行偏差
• 情绪影响
• 资金限制
• 风控干预
```

**缩小差异的方法**
```
• 保守的回测假设
• 留足安全边际
• 渐进式实盘（小资金→大资金）
• 严格的止损机制
```

### 4.4 回测框架设计原则

**模块化设计**
```
原则：
• 数据、策略、执行、分析分离
• 各部分可独立测试
• 易于扩展和替换

好处：
• 代码复用
• 团队协作
• 便于维护
```

**可复现性**
```
要求：
• 固定随机种子
• 记录所有配置
• 版本控制（代码和数据）
• 完整的日志记录

验证：
• 相同输入，相同输出
• 便于问题排查
• 结果可信
```

---

## 五、核心概念总结

```
┌─────────────────────────────────────────────────────────┐
│                回测框架核心要点                          │
├─────────────────────────────────────────────────────────┤
│  回测类型                                              │
│  ├── 向量化回测：快速验证想法，适合研究阶段             │
│  └── 事件驱动回测：精细模拟，接近实盘，适合最终验证     │
├─────────────────────────────────────────────────────────┤
│  核心组件                                              │
│  ├── 数据层：时点一致，严防前视偏差                     │
│  ├── 策略层：信号生成、仓位管理、风险控制               │
│  ├── 执行层：成交模型、滑点、冲击成本                   │
│  ├── 账户层：持仓、资金、盈亏计算                       │
│  └── 分析层：收益、风险、交易统计                       │
├─────────────────────────────────────────────────────────┤
│  关键流程                                              │
│  ├── 参数优化：Walk-forward避免前视                     │
│  ├── 稳健性检验：多环境、多参数、压力测试               │
│  └── 实盘过渡：纸交易 → 小资金 → 全资金                 │
├─────────────────────────────────────────────────────────┤
│  常见陷阱                                              │
│  ├── 前视偏差：使用未来信息                             │
│  ├── 幸存者偏差：忽略退市公司                           │
│  ├── 过拟合：过度优化历史表现                           │
│  ├── 成本低估：忽视滑点和冲击成本                       │
│  └── 流动性假设：假设无限流动性                         │
├─────────────────────────────────────────────────────────┤
│  设计原则                                              │
│  ├── 保守假设：宁可高估成本                             │
│  ├── 模块化：组件分离，易于维护                         │
│  ├── 可复现：记录所有配置和随机种子                     │
│  └── 安全缓冲：回测打折扣再用于实盘                     │
└─────────────────────────────────────────────────────────┘
```

---

*文档创建时间：2026-02-24*  
*所属阶段：Phase 3 - 量化技能（第13/20项）*
