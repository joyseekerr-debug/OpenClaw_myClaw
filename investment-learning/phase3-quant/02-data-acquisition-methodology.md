# Phase 3-2: 数据获取方法论

## 一、概念定义

### 1.1 金融数据分类

**按资产类别：**
- **股票数据**：价格、成交量、基本面、财报
- **期货数据**：合约信息、持仓量、交割日期
- **期权数据**：隐含波动率、希腊字母、行权价
- **外汇数据**：汇率、交叉盘、远期点
- **加密货币数据**：24h交易量、链上数据

**按数据类型：**
- **行情数据（Market Data）**：OHLCV（开高低收量）
- **基本面数据（Fundamental Data）**：财务指标、估值比率
- **宏观数据（Macro Data）**：利率、通胀、GDP
- **另类数据（Alternative Data）**：舆情、卫星、消费

**按时间粒度：**
| 频率 | 用途 | 存储需求 |
|------|------|----------|
| Tick | 高频策略、市场微观结构 | 极高 |
| 分钟 | 日内策略、量化交易 | 高 |
| 日频 | 因子投资、组合优化 | 中等 |
| 周/月 | 宏观分析、长期配置 | 低 |

### 1.2 数据源类型

**官方数据源：**
- **交易所**：上交所、深交所、CME、NYSE（权威但成本高）
- **数据供应商**：Bloomberg、Refinitiv、Wind、同花顺iFinD

**免费/开源数据源：**
- **Yahoo Finance**：全球股票、ETF（免费但有延迟）
- **Tushare**：中国A股数据（积分制）
- **AKShare**：开源财经数据接口
- **Quandl/NASDAQ Data Link**：金融、经济数据库

**API与直接连接：**
- **券商API**：Interactive Brokers、富途、雪球
- **专用数据服务**：Polygon.io、Alpaca、IEX Cloud

---

## 二、算法原理

### 2.1 数据获取架构

```
┌─────────────────────────────────────────────────────────┐
│                    数据获取系统架构                       │
├─────────────────────────────────────────────────────────┤
│  数据层（Data Sources）                                   │
│  ├── 实时流（WebSocket/FIX）                              │
│  ├── 批量下载（REST API/ FTP）                            │
│  └── 文件导入（CSV/ Parquet）                             │
├─────────────────────────────────────────────────────────┤
│  处理层（ETL Pipeline）                                   │
│  ├── 抽取（Extract）：API调用、网页爬取                   │
│  ├── 转换（Transform）：格式标准化、质量控制              │
│  └── 加载（Load）：数据库写入、缓存更新                   │
├─────────────────────────────────────────────────────────┤
│  存储层（Storage）                                        │
│  ├── 时序数据库（TimescaleDB/InfluxDB）                   │
│  ├── 关系数据库（PostgreSQL/MySQL）                       │
│  └── 对象存储（S3/MinIO）：原始文件归档                   │
├─────────────────────────────────────────────────────────┤
│  服务层（Data Service）                                   │
│  ├── 数据API：内部服务调用                                │
│  └── 缓存层：Redis/Memcached                              │
└─────────────────────────────────────────────────────────┘
```

### 2.2 API调用策略

**请求频率控制**
```
速率限制算法：
• 令牌桶（Token Bucket）：平滑突发流量
• 漏桶（Leaky Bucket）：恒定输出速率
• 固定窗口：简单计数，可能有突发
```

**错误处理与重试**
| 错误类型 | 处理策略 | 重试间隔 |
|----------|----------|----------|
| 429 Too Many Requests | 指数退避 | 1s → 2s → 4s → 8s |
| 503 Service Unavailable | 固定间隔重试 | 5秒 |
| 超时 | 立即重试（限3次） | 0秒 |
| 403 Forbidden | 停止并告警 | 不重试 |

### 2.3 实时数据流处理

**WebSocket连接管理**
```
心跳机制：
• 客户端定期发送ping
• 服务端返回pong
• 超时未响应则重连

重连策略：
• 指数退避：1s, 2s, 4s, 8s...（上限60s）
• 连接成功后重置计数
• 记录断线期间数据缺口
```

**数据一致性保障**
```
序列号检查：检测丢包
时间戳对齐：处理乱序到达
缓存窗口：等待延迟数据（如允许500ms）
```

---

## 三、应用场景

### 3.1 量化投资数据需求

**策略研发阶段**
```
数据需求：
├── 历史行情数据（日频/分钟）
├── 财务报表数据（季度/年度）
├── 行业分类与成分股变更
├── 分红送配、拆股复权信息
└── 基准指数数据（用于对比）

关键考量：
• 数据长度（至少覆盖一个完整牛熊周期）
•  survivor bias（避免幸存者偏差）
•  look-ahead bias（避免使用未来数据）
```

**回测验证阶段**
```
数据需求：
├── 除权除息调整后的价格
├── 停牌标识（避免虚假交易信号）
├── 涨跌停标识（模拟真实成交难度）
├── 交易量数据（评估冲击成本）
└── 逐笔数据（高精度回测）
```

**实盘交易阶段**
```
数据需求：
├── Level 2行情（十档盘口、委托队列）
├── 实时成交数据
├── 账户资金与持仓
├── 市场深度与流动性
└── 新闻舆情流（事件驱动策略）
```

### 3.2 数据源选择矩阵

| 应用场景 | 推荐数据源 | 成本 | 数据质量 |
|----------|------------|------|----------|
| 学术研究 | Yahoo Finance + Tushare | 免费 | 中等 |
| 个人量化 | AKShare + 券商API | 低 | 中等 |
| 专业机构 | Wind/同花顺iFinD | 高 | 高 |
| 高频交易 | 交易所直连 | 极高 | 最高 |
| 全球配置 | Bloomberg/Refinitiv | 极高 | 最高 |

### 3.3 数据获取最佳实践

**多源数据校验**
```
校验方法：
• 价格交叉验证：同一股票多个数据源对比
• 成交量一致性检查：日成交与分钟成交累加
• 收益率合理性：检查极端值（>50%单日）
• 时间连续性：检查缺失交易日
```

**增量更新策略**
```
设计原则：
• 只获取变化数据，减少API调用
• 记录上次更新时间戳
• 支持断点续传
• 数据版本管理（便于回滚）
```

---

## 四、注意事项

### 4.1 法律与合规

**数据使用限制**
```
⚠️ 禁止行为：
• 未经授权将数据转售给第三方
• 突破API速率限制（可能违法CFAA）
• 爬取非公开数据
• 使用内幕信息

✅ 合规做法：
• 仔细阅读服务条款（ToS）
• 仅用于个人/机构授权用途
• 遵守交易所数据使用规定
• 保留数据获取审计日志
```

### 4.2 数据质量问题

| 问题类型 | 表现 | 检测方法 | 解决方案 |
|----------|------|----------|----------|
| 幸存者偏差 | 只包含现存公司 | 检查退市股票 | 获取全量历史数据 |
| 前视偏差 | 使用未来信息 | 时间戳对齐检查 | 严格的时间窗口管理 |
| 价格偏差 | 未复权或错误复权 | 收益率异常检测 | 使用标准化复权因子 |
| 时间错位 | 不同市场时区问题 | UTC统一时间戳 | 明确标注时区信息 |
| 数据缺失 | 停牌/节假日 | 完整性检查 | 标记缺失而非填充 |

### 4.3 技术陷阱

**常见错误**
```
❌ 硬编码API密钥（应使用环境变量）
❌ 无限制循环请求（导致IP被封）
❌ 同步阻塞IO（降低吞吐量）
❌ 内存中保留全量数据（OOM风险）
❌ 忽略数据类型（精度丢失）
```

**架构建议**
```
✅ 异步IO（aiohttp/asyncio）
✅ 连接池复用
✅ 流式写入（避免内存溢出）
✅ 监控告警（成功率、延迟）
✅ 数据校验流水线
```

### 4.4 成本管理

**成本构成分析**
```
直接成本：
• API订阅费用
• 数据供应商许可费
• 云存储费用
• 带宽费用

间接成本：
• 开发维护人力
• 数据清洗时间
• 存储扩容成本
• 合规审计成本
```

**成本优化策略**
```
• 冷热数据分离：热数据SSD，冷数据对象存储
• 数据压缩：Parquet格式替代CSV
• 按需获取：仅订阅所需数据范围
• 缓存策略：合理设置TTL避免重复请求
```

---

## 五、核心概念总结

```
┌──────────────────────────────────────────────────────┐
│              数据获取方法论核心要点                   │
├──────────────────────────────────────────────────────┤
│  数据分层                                            │
│  ├── 原始数据层：保持未经修改的原始数据               │
│  ├── 清洗数据层：标准化、去重、校验后的数据           │
│  └── 特征数据层：供模型直接使用的衍生数据             │
├──────────────────────────────────────────────────────┤
│  质量控制                                            │
│  ├── 完整性：无缺失、无断点                           │
│  ├── 准确性：多源交叉验证                             │
│  ├── 一致性：时间对齐、格式统一                       │
│  └── 时效性：延迟在可接受范围内                       │
├──────────────────────────────────────────────────────┤
│  关键原则                                            │
│  ├── 永远不要相信输入数据（防御性编程）               │
│  ├── 保留原始数据便于问题追溯                         │
│  ├── 数据版本管理与可重复性                           │
│  └── 合规优先，法律风险零容忍                         │
└──────────────────────────────────────────────────────┘
```

---

*文档创建时间：2026-02-24*  
*所属阶段：Phase 3 - 量化技能（第2/20项）*
