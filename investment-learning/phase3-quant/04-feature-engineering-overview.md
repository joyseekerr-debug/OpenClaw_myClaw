# Phase 3-4: 特征工程概述

## 一、概念定义

### 1.1 特征工程（Feature Engineering）
使用领域知识从原始数据中提取、构造、选择和转换特征，以提高机器学习模型性能的过程。

**核心目标：**
- **提升模型表现**：更好的特征胜过更好的算法
- **降低复杂度**：减少特征数量，提高计算效率
- **增强可解释性**：发现数据的内在结构
- **处理非结构化数据**：将文本、图像等转换为数值特征

### 1.2 特征类型

**按数据类型：**
| 类型 | 描述 | 示例 |
|------|------|------|
| 数值特征 | 连续或离散的数值 | 价格、成交量、收益率 |
| 类别特征 | 有限个离散取值 | 行业、交易所、评级 |
| 时间特征 | 与时间相关的属性 | 年月日、季度、节假日 |
| 文本特征 | 自然语言数据 | 新闻、公告、研报 |
| 交叉特征 | 多个特征的交互 | 价格×成交量 |

**按生成方式：**
- **原始特征**：直接来自数据源的字段
- **派生特征**：通过计算从原始特征得到
- **聚合特征**：在特定维度上的统计量
- **嵌入特征**：通过深度学习模型学习得到

### 1.3 金融特征工程特点

```
金融数据的特殊性：
├── 时间序列特性：自相关、趋势、季节性
├── 高噪声比：信号弱、噪声大
├── 非平稳性：统计特性随时间变化
├──  fat-tailed：极端事件概率高于正态分布
└── 多尺度性：不同时间尺度的模式共存
```

---

## 二、算法原理

### 2.1 特征构造方法

**数学变换**
```
基础运算：
• 加减乘除：价格 - MA(20)
• 比率：收盘价/开盘价
• 对数：log(成交量)
• 幂次：sqrt(波动率)

统计变换：
• 排名（Rank）：横截面排名
• 分位数（Quantile）：百分位位置
• Z-Score：标准化后的偏离程度
• 偏度/峰度：分布形态度量
```

**时间序列特征**
```
滞后特征（Lag Features）：
• 滞后收益率：昨日、上周、上月收益
• 滞后波动率：历史波动率
• 滞后成交量：前期量能

滚动窗口特征：
• 移动平均：MA(5), MA(20), MA(60)
• 滚动标准差：波动率估计
• 滚动最大/最小：区间高低点
• 滚动相关系数：股票间相关性

差分特征：
• 一阶差分：价格变化
• 季节性差分：同比变化
• 对数差分：对数收益率
```

**金融专有特征**
```
技术指标特征：
• RSI相对强弱指标
• MACD异同移动平均线
• 布林带位置
• 动量指标

量价特征：
• 量价背离
• 换手率
• 资金流向
• 委托 imbalance

基本面特征：
• PE/PB/PS比率
• ROE/ROA
• 增长率
• 财务健康度评分
```

### 2.2 特征选择方法

**过滤法（Filter）**
```
基于统计检验：
• 皮尔逊相关系数：线性关系
• Spearman秩相关：单调关系
• 互信息（Mutual Information）：非线性关系
• 卡方检验：类别特征与目标

优点：计算快，独立于模型
缺点：不考虑特征间交互
```

**包装法（Wrapper）**
```
递归特征消除（RFE）：
1. 用全部特征训练模型
2. 计算特征重要性
3. 剔除最弱特征
4. 重复直到满足数量要求

前向选择：
1. 从空特征集开始
2. 每次添加提升最大的特征
3. 直到性能不再提升

优点：考虑特征组合效果
缺点：计算成本高，容易过拟合
```

**嵌入法（Embedded）**
```
模型内置选择：
• L1正则化（Lasso）：自动产生稀疏解
• 树模型重要性：Gini重要性、排列重要性
• 弹性网络：L1+L2组合

优点：训练与选择一体化
缺点：依赖于特定模型
```

### 2.3 特征降维

**线性方法**
```
主成分分析（PCA）：
• 寻找方差最大的正交方向
• 保留主要成分，丢弃噪声
• 假设线性关系

因子分析：
• 假设存在隐变量（因子）
• 估计因子载荷矩阵
• 适合有明确因子结构的数据
```

**非线性方法**
```
t-SNE：
• 保持局部邻域结构
• 适合可视化高维数据
• 不适合特征提取

UMAP：
• 保持全局和局部结构
• 计算效率高于t-SNE
• 可用于降维和可视化

自编码器（Autoencoder）：
• 神经网络学习压缩表示
• 可学习非线性降维
• 适合复杂数据结构
```

**金融领域特殊考虑**
```
行业PCA：
• 行业内股票收益率PCA
• 提取共同因子

风险因子降维：
• Barra风格因子模型
• 降维后仍保持可解释性
```

### 2.4 特征编码

**类别特征编码**
```
独热编码（One-Hot）：
• 每个类别一个二进制列
• 适合低基数类别
• 缺点：高基数时维度爆炸

标签编码（Label Encoding）：
• 类别映射为整数
• 适合树模型
• 缺点：引入虚假序关系

目标编码（Target Encoding）：
• 用目标变量均值替代类别
• 适合高基数类别
• 需要防止过拟合（平滑、交叉验证）

频数/计数编码：
• 用出现频数编码
• 简单有效
• 适合与出现频率相关的场景
```

---

## 三、应用场景

### 3.1 量化因子构建流程

```
原始数据 → 特征构造 → 特征选择 → 因子合成 → 因子检验

特征构造示例（动量因子）：
• 基础：过去20日收益率
• 变体：过去60日收益率
• 改进：剔除最近5日的63日收益率（避免反转）
• 组合：多个时间尺度的加权平均

因子合成方法：
• 等权组合
• 信息比率加权
• 主成分提取
• 机器学习组合
```

### 3.2 机器学习选股特征

**典型特征体系**
```
价量特征：
├── 收益率类：日收益、周收益、月收益
├── 波动类：日波动、实现波动率、GARCH波动
├── 趋势类：均线位置、MACD、RSI
├── 成交类：换手率、量比、资金流向
└── 形态类：布林带位置、通道突破

基本面特征：
├── 估值类：PE、PB、PS、PCF、EV/EBITDA
├── 质量类：ROE、ROA、毛利率、净利率
├── 成长类：营收增长率、利润增长率
├── 杠杆类：资产负债率、流动比率
└── 情绪类：分析师预期、评级变化

宏观特征：
├── 市场类：指数收益率、市场波动
├── 利率类：国债收益率、信用利差
├── 商品类：商品价格、汇率
└── 情绪类：VIX、投资者情绪指数
```

### 3.3 高频交易特征

**微观结构特征**
```
订单簿特征：
• 买卖价差（Bid-Ask Spread）
• 订单簿深度（Depth）
• 买卖不平衡（Order Imbalance）
• 订单流毒性（VPIN）

成交特征：
• 成交方向分类（ buys vs sells）
• 大单识别
• 成交频率
• 价格冲击

时间特征：
• 日内时间效应（开盘、收盘）
• 事件时间（距公告时间）
• 等待时间（Time between trades）
```

---

## 四、注意事项

### 4.1 前视偏差预防

**风险点**
```
❌ 使用未来均值填充缺失
❌ 用全样本统计量标准化
❌ 基于未来信息选择特征
❌ 用未来标签计算目标编码
```

**防护措施**
```
✅ 滚动窗口计算：只用过去数据
✅ 分组交叉验证：按时间划分
✅ 逐点计算：每个时点独立处理
✅ 延迟使用：信息公布后N日才使用

滚动窗口标准化示例：
• 第t日的标准化参数 = 过去252日的均值和标准差
• 第t日的分位数 = 在过去252日中的排名
```

### 4.2 特征共线性

**问题表现**
```
• 高相关性特征导致系数不稳定
• 多重共线性使模型难以解释
• 冗余特征增加过拟合风险
```

**检测与处理**
```
检测方法：
• 相关系数矩阵热力图
• VIF（方差膨胀因子）：VIF > 10表示严重共线
• 条件数：过大表示共线性

处理方法：
• 删除高相关特征中的一个
• 主成分分析降维
• 正则化（Ridge/Lasso）
• 领域知识选择保留哪个
```

### 4.3 过拟合风险

| 风险来源 | 表现 | 解决方案 |
|----------|------|----------|
| 特征过多 | 维度灾难 | 特征选择、降维、正则化 |
| 过度搜索 | 数据窥探 | 预注册假设、样本外验证 |
| 复杂变换 | 过度拟合噪声 | 简单优先原则、交叉验证 |
| 目标泄露 | 标签信息流入特征 | 严格时序划分、特征审查 |

### 4.4 可解释性维护

**金融领域的可解释性要求**
```
为什么重要：
• 监管要求（可解释AI）
• 风险管理需要
• 策略优化依据
• 投资者沟通

保持可解释性的方法：
• 优先使用有经济含义的特征
• 记录特征构造逻辑
• 分析特征重要性
• 避免黑盒变换
```

---

## 五、核心概念总结

```
┌─────────────────────────────────────────────────────────┐
│                特征工程核心框架                          │
├─────────────────────────────────────────────────────────┤
│  特征构造（Feature Construction）                        │
│  ├── 数学变换：对数、比率、差分                         │
│  ├── 时序特征：滞后、滚动、扩张                         │
│  ├── 领域特征：技术指标、基本面指标                     │
│  └── 交叉特征：特征间的交互组合                         │
├─────────────────────────────────────────────────────────┤
│  特征选择（Feature Selection）                           │
│  ├── 过滤法：统计检验快速筛选                           │
│  ├── 包装法：模型反馈迭代选择                           │
│  └── 嵌入法：模型内置自动选择                           │
├─────────────────────────────────────────────────────────┤
│  特征降维（Feature Reduction）                           │
│  ├── 线性方法：PCA、因子分析                            │
│  ├── 非线性方法：t-SNE、UMAP、Autoencoder               │
│  └── 领域方法：行业PCA、风险因子模型                    │
├─────────────────────────────────────────────────────────┤
│  关键原则                                              │
│  ├── 领域知识驱动：金融含义优先                         │
│  ├── 时序安全：严格防止前视偏差                         │
│  ├── 可解释性：避免黑盒变换                             │
│  └── 验证为王：样本外测试必不可少                       │
└─────────────────────────────────────────────────────────┘
```

---

*文档创建时间：2026-02-24*  
*所属阶段：Phase 3 - 量化技能（第4/20项）*
