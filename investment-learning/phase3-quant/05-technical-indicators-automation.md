# Phase 3-5: 技术指标自动化计算思路

## 一、概念定义

### 1.1 技术指标自动化
将传统技术分析中的指标计算方法系统化、程序化，使其能够在历史数据和实时数据上自动计算和更新。

**自动化目标：**
- **批量计算**：同时处理多只股票、多个时间周期
- **实时更新**：新数据到达时增量更新指标值
- **标准化输出**：统一的格式便于后续分析
- **可扩展性**：方便添加新的技术指标

### 1.2 技术指标分类

**按计算基础：**
| 类别 | 说明 | 典型指标 |
|------|------|----------|
| 趋势指标 | 识别价格趋势方向 | MA、MACD、ADX |
| 动量指标 | 测量价格变化速度 | RSI、KDJ、CCI |
| 波动指标 | 衡量价格波动程度 | ATR、布林带、唐奇安通道 |
| 成交量指标 | 分析成交量变化 | OBV、量价趋势、资金流量 |
|  sentiment指标 | 测量市场情绪 | 心理线、涨跌比率 |

**按计算复杂度：**
```
基础指标：单步计算
├── 简单移动平均（SMA）
├── 价格变化率（ROC）
└── 振幅、涨跌幅

中级指标：多步运算
├── 指数移动平均（EMA）
├── 相对强弱指标（RSI）
└── 布林带（Bollinger Bands）

高级指标：递归/复合计算
├── MACD（多EMA组合）
├── KDJ（多步随机指标）
└── 自适应指标（参数动态调整）
```

### 1.3 自动化挑战

```
计算挑战：
├── 历史数据依赖：需要足够长的历史数据
├── 边界处理：数据不足时的处理
├── 增量计算：新数据到达时的效率
├── 精度问题：浮点数累积误差
└── 复权处理：除权除息后的连续计算

工程挑战：
├── 性能要求：大批量股票实时计算
├── 内存管理：大量指标数据的存储
├── 容错处理：异常数据的健壮性
└── 一致性保证：不同时间点的计算一致
```

---

## 二、算法原理

### 2.1 基础计算架构

**批处理架构**
```
输入：历史价格数据（OHLCV）
      ↓
预处理：数据清洗、复权调整
      ↓
指标计算：批量应用公式
      ↓
输出：指标时间序列
```

**流式计算架构**
```
新数据到达 → 增量更新状态 → 输出新指标值

状态管理：
• 保留必要的中间状态
• EMA：保留上一期EMA值
• RSI：保留涨跌和平均涨跌
• 布林带：保留移动平均和方差
```

### 2.2 常见指标计算原理

**移动平均类**
```
简单移动平均（SMA）：
SMA_t = (P_t + P_{t-1} + ... + P_{t-n+1}) / n

指数移动平均（EMA）：
EMA_t = α × P_t + (1-α) × EMA_{t-1}
其中 α = 2 / (n + 1)

加权移动平均（WMA）：
WMA_t = Σ(w_i × P_{t-i}) / Σ(w_i)
```

**动量指标**
```
相对强弱指标（RSI）：
RSI = 100 - 100 / (1 + RS)
RS = 平均上涨幅度 / 平均下跌幅度

随机指标（KDJ）：
K = 100 × (C - L14) / (H14 - L14)
D = 3日K的平均
J = 3K - 2D

MACD：
DIF = EMA(12) - EMA(26)
DEA = EMA(DIF, 9)
MACD = 2 × (DIF - DEA)
```

**波动指标**
```
平均真实波幅（ATR）：
TR = max(|H-L|, |H-C_prev|, |L-C_prev|)
ATR = SMA(TR, n)

布林带：
中轨 = SMA(20)
上轨 = 中轨 + 2 × σ
下轨 = 中轨 - 2 × σ
```

### 2.3 增量计算算法

**EMA增量计算**
```
传统方法（全量）：
每次从头计算所有历史点

增量方法：
保留 EMA_{t-1}
新EMA_t = α × P_t + (1-α) × EMA_{t-1}
时间复杂度：O(1) vs O(n)
```

**RSI增量计算**
```
需要保留状态：
• 上一期平均上涨 AvgGain_{t-1}
• 上一期平均下跌 AvgLoss_{t-1}

增量公式：
AvgGain_t = (AvgGain_{t-1} × 13 + CurrentGain) / 14
AvgLoss_t = (AvgLoss_{t-1} × 13 + CurrentLoss) / 14
```

**滚动窗口高效计算**
```
滑动窗口技巧：
• 维护窗口内的统计量（和、平方和）
• 新点加入，旧点移除
• 避免重复计算

标准差滚动计算：
var = (sum_sq - sum²/n) / n
只需维护sum和sum_sq两个累积量
```

### 2.4 复权处理原理

**前复权计算**
```
复权因子链：
当日复权因子 = 前一日复权因子 × 当日调整因子

增量更新规则：
• 无除权：复权因子不变
• 除权：复权因子 × 调整系数
• 历史指标：可用前复权价格重新计算
```

**指标连续性保证**
```
问题：除权日指标突变
解决：使用复权价格计算
注意：成交量不复权
```

---

## 三、应用场景

### 3.1 多指标批量计算系统

**典型设计**
```
指标库设计：
├── 基础指标模块
│   ├── MovingAverage（支持SMA/EMA/WMA）
│   ├── Volatility（ATR、标准差）
│   └── Momentum（RSI、MACD、CCI）
├── 复合指标模块
│   ├── BollingerBands
│   ├── KDJ
│   └── Ichimoku
└── 自定义指标接口

配置驱动：
{
  "indicators": [
    {"name": "SMA", "params": {"window": 20}},
    {"name": "RSI", "params": {"window": 14}},
    {"name": "MACD", "params": {"fast": 12, "slow": 26, "signal": 9}}
  ]
}
```

### 3.2 实时指标计算

**WebSocket + 增量计算**
```
数据流：
交易所 → 行情网关 → 指标引擎 → 策略系统

指标引擎设计：
• 状态缓存：每个股票维护指标状态
• 增量更新：新tick触发增量计算
• 批量刷新：定时批量持久化

性能优化：
• 热点股票优先缓存
• 冷启动预加载
• 多进程并行计算
```

### 3.3 多时间周期计算

**周期映射关系**
```
时间周期层次：
Tick → 分钟 → 小时 → 日 → 周 → 月

聚合逻辑：
分钟K线：
  开 = 该分钟第一笔成交价
  高 = 该分钟最高价
  低 = 该分钟最低价
  收 = 该分钟最后一笔成交价
  量 = 该分钟成交量总和

多周期指标：
• 小周期指标可作为大周期输入
• 注意周期边界对齐
• 交易日历处理（节假日）
```

### 3.4 信号生成与回测

**信号生成规则**
```
金叉/死叉：
• 短期均线上穿长期均线 → 买入信号
• 短期均线下穿长期均线 → 卖出信号

超买/超卖：
• RSI > 70 → 超买（卖出）
• RSI < 30 → 超卖（买入）

布林带：
• 价格触及下轨 → 买入
• 价格触及上轨 → 卖出
```

**回测注意事项**
```
⚠️ 信号闪烁（Repainting）：
• 盘中指标值可能随新数据改变
• 回测应使用收盘价确认信号
• 或使用下一周期开盘价执行

⚠️ 计算延迟：
• 指标计算需要时间
• 实盘应考虑计算延迟
• 高频策略需使用预估价格
```

---

## 四、注意事项

### 4.1 精度与数值问题

**常见问题**
```
浮点精度累积：
• EMA长期运行后精度漂移
• 解决方案：定期重置或使用高精度类型

除零错误：
• 标准差为0时的分母
• 成交量为0时的除法
• 需要添加保护性判断

极端值处理：
• 涨跌停时的价格不变
• 停牌时的数据缺失
• 新股上市初期的数据不足
```

**最佳实践**
```
数值稳定性：
• 使用对数计算避免溢出：log(a/b) vs a/b
• 移动平均使用Welford算法计算方差
• 价格使用Decimal类型保持精度
```

### 4.2 性能优化

| 优化点 | 策略 | 效果 |
|--------|------|------|
| 向量化计算 | 使用NumPy/Pandas向量化 | 10-100x加速 |
| 增量更新 | 避免全量重新计算 | 常数时间复杂度 |
| 缓存策略 | LRU缓存热点数据 | 减少IO和计算 |
| 并行计算 | 多进程处理多股票 | 线性扩展 |
| 预计算 | 非交易时段批量计算 | 降低实时压力 |

### 4.3 数据质量保证

**数据校验清单**
```
□ 价格逻辑检查：高 ≥ 低 ≥ 0，收在开高低范围内
□ 时间连续性：无缺失交易日（除节假日）
□ 成交量合理性：非负，不过于异常
□ 复权因子连续性：无跳跃或负值
□ 数据长度检查：满足指标计算的最小历史
```

### 4.4 指标有效性验证

**验证方法**
```
对比验证：
• 与权威平台（Bloomberg、Wind）对比
• 与开源库（TA-Lib）对比
• 手工计算小样本验证

边界测试：
• 数据不足时的行为
• 极端市场条件下的表现
• 长时间运行的稳定性
```

---

## 五、核心概念总结

```
┌─────────────────────────────────────────────────────────┐
│              技术指标自动化计算框架                      │
├─────────────────────────────────────────────────────────┤
│  计算模式                                              │
│  ├── 批处理模式：历史数据全量计算                       │
│  ├── 流式模式：实时数据增量更新                         │
│  └── 混合模式：批处理初始化 + 流式增量                  │
├─────────────────────────────────────────────────────────┤
│  关键算法                                              │
│  ├── 滚动窗口：高效维护窗口统计量                       │
│  ├── 增量更新：保留状态，O(1)更新                       │
│  ├── 复权处理：保持指标连续性                           │
│  └── 边界处理：数据不足时的合理降级                     │
├─────────────────────────────────────────────────────────┤
│  设计原则                                              │
│  ├── 配置化：参数可配置，便于调优                       │
│  ├── 模块化：指标独立实现，易于扩展                     │
│  ├── 性能优先：向量化、增量、并行                       │
│  └── 鲁棒性：异常处理、精度控制                         │
├─────────────────────────────────────────────────────────┤
│  量化注意事项                                          │
│  ├── 前视偏差：只用当时可计算的数据                     │
│  ├── 信号确认：避免盘中信号闪烁                         │
│  ├── 滑点模拟：实盘执行与信号的差异                     │
│  └── 成本考虑：换手频率与交易成本                       │
└─────────────────────────────────────────────────────────┘
```

---

*文档创建时间：2026-02-24*  
*所属阶段：Phase 3 - 量化技能（第5/20项）*
