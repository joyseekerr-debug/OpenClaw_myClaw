# 37. 异常事件处理 (Exception Handling)

## 概念定义

异常事件处理是指在监控系统发现异常情况后，按照预设流程进行响应、处置和恢复的完整过程。有效的异常处理机制是风险管理的最后一道防线。

## 异常事件分类

### 按来源分类
```
1. 市场异常
   ├── 价格异常（闪崩、闪涨）
   ├── 流动性异常（无法成交）
   ├── 数据异常（行情中断、错误数据）
   └── 系统性风险（市场崩盘）

2. 交易异常
   ├── 订单异常（拒绝、超时）
   ├── 成交异常（错单、重复成交）
   ├── 持仓异常（对账不平）
   └── 资金异常（资金不足、冻结）

3. 系统异常
   ├── 网络异常（断线、延迟）
   ├── 硬件异常（服务器故障）
   ├── 软件异常（程序崩溃、Bug）
   └── 数据异常（丢失、损坏）

4. 合规异常
   ├── 限额突破（超过风控限制）
   ├── 交易限制（涨跌停、停牌）
   └── 监管要求（信息披露）
```

### 按严重程度分类
```
P0 - 致命：
- 系统完全不可用
- 重大资金损失
- 需要立即人工介入

P1 - 严重：
- 核心功能受影响
- 较大潜在损失
- 需要1小时内处理

P2 - 一般：
- 非核心功能异常
- 较小影响
- 可以延后处理

P3 - 轻微：
- 提示性异常
- 几乎无影响
- 记录观察即可
```

## 异常处理流程

### 标准处理流程
```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 发现异常 │ → │ 初步评估 │ → │ 应急响应 │ → │ 恢复处理 │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
                                                  │
┌─────────┐    ┌─────────┐    ┌─────────┐        │
│ 复盘改进 │ ← │ 记录归档 │ ← │ 验证确认 │ ←─────┘
└─────────┘    └─────────┘    └─────────┘
```

### 各阶段要点

#### 1. 发现异常
```
发现渠道：
- 自动监控报警
- 人工巡检发现
- 用户反馈
- 对账发现

记录要素：
- 异常发生时间
- 异常现象描述
- 涉及标的/账户
- 初步影响评估
```

#### 2. 初步评估
```
评估维度：
- 严重程度（P0-P3）
- 影响范围（单个/多个/全部）
- 紧急程度（立即/尽快/一般）
- 处理难度（简单/中等/复杂）

决策：
- 自行处理 or 升级
- 立即处理 or 延后
- 需要哪些资源
```

#### 3. 应急响应
```
即时措施：
- 暂停相关交易
- 启动备用系统
- 通知相关人员
- 保护现场（日志、数据）

止损措施：
- 强制平仓
- 启动对冲
- 限制交易
```

#### 4. 恢复处理
```
处理步骤：
- 定位根本原因
- 制定解决方案
- 执行修复操作
- 验证修复结果

常见处理：
- 数据错误 → 修正数据、重算
- 系统故障 → 切换备用、修复
- 交易错误 → 冲正、协商
```

#### 5. 验证确认
```
验证内容：
- 问题是否解决
- 是否有副作用
- 数据是否一致
- 系统是否稳定

确认标准：
- 监控指标正常
- 交易功能恢复
- 相关人员确认
```

#### 6. 记录归档
```
记录内容：
- 事件描述
- 处理过程
- 根本原因
- 解决方案
- 经验教训

报告要素：
- 时间线
- 影响评估
- 处理耗时
- 改进建议
```

#### 7. 复盘改进
```
复盘会议：
- 相关人员参加
- 还原事件经过
- 分析根本原因
- 讨论改进措施

改进措施：
- 制度完善
- 系统优化
- 流程改进
- 培训加强
```

## 常见异常处理方案

### 行情数据异常
```
现象：
- 价格数据不更新
- 价格数据异常（如0元、负数）
- 数据延迟过大

处理：
1. 切换到备用数据源
2. 暂停依赖该数据的交易
3. 通知数据提供商
4. 人工核实关键数据
5. 数据恢复后验证一致性
```

### 交易执行异常
```
现象：
- 订单被拒绝
- 订单超时
- 重复下单
- 成交价格异常

处理：
1. 立即暂停相关策略
2. 核实订单状态（交易所确认）
3. 未成交订单撤销
4. 重复订单对冲或协商取消
5. 错单按预案处理
```

### 风险限额突破
```
现象：
- VaR超限
- 单日回撤超限
- 单一标的持仓超限

处理：
1. 立即暂停新增交易
2. 评估是否需要减仓
3. 计算需要减仓的数量
4. 执行减仓（市场条件允许）
5. 上报并记录
6. 恢复后重新评估限额
```

### 系统故障
```
现象：
- 程序崩溃
- 服务器宕机
- 网络中断

处理：
1. 自动切换到备用系统
2. 通知运维人员
3. 启动故障排查
4. 修复主系统
5. 验证后切换回主系统
6. 分析故障原因
```

## 应急预案

### 预案制定原则
```
1. 全面覆盖
   - 各类可能异常
   - 不同严重程度

2. 明确职责
   - 谁负责决策
   - 谁负责执行
   - 谁负责通知

3. 操作具体
   - 步骤清晰
   - 命令可复制
   - 联系方式准确

4. 定期演练
   - 桌面演练
   - 模拟演练
   - 实战演练
```

### 预案内容模板
```
预案名称：
触发条件：
影响范围：
响应时间：

处理步骤：
1. ...
2. ...
3. ...

联系人：
- 第一联系人：姓名 电话
- 第二联系人：姓名 电话

事后处理：
- 数据恢复
- 对账处理
- 报告提交
```

---
*文档版本：v1.0 | 投资技能学习系列*
