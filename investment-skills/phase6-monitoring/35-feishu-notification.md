# 35. 飞书通知集成 (Feishu Notification Integration)

## 概念定义

飞书通知集成是指将投资监控系统的预警信息通过飞书平台推送给用户，实现即时、便捷、丰富的消息通知功能。

## 飞书通知类型

### 1. 文本消息
```
适用场景：
- 简单预警信息
- 快速通知
- 低优先级提醒

格式：
纯文本内容，支持@提及

示例：
【价格预警】贵州茅台(600519) 当前价格 1705.00，
已触及目标价位 1700.00，请关注。
```

### 2. 富文本消息（Post）
```
适用场景：
- 结构化信息展示
- 多字段数据
- 中等优先级提醒

支持格式：
- 标题
- 正文（支持加粗、颜色）
- 链接
- 图片

示例结构：
┌─────────────────────────────────────┐
│ 🔴 重要预警 - 单日回撤超限          │
├─────────────────────────────────────┤
│ 预警时间：2024-01-15 14:32:18       │
│ 组合名称：成长型策略组合            │
│ 当日盈亏：-3.25%                    │
│ 预警阈值：-3.00%                    │
│ 最大亏损标的：XXX科技 (-5.8%)       │
│                                     │
│ [查看详情] [暂停策略] [联系风控]    │
└─────────────────────────────────────┘
```

### 3. 卡片消息（Interactive Card）
```
适用场景：
- 交互式预警
- 需要用户操作
- 高优先级通知

支持元素：
- 多列布局
- 按钮操作
- 下拉选择
- 日期选择

示例结构：
┌─────────────────────────────────────┐
│ ⚠️ 紧急 - 风险限额突破              │
├─────────────────────────────────────┤
│ 当前敞口：¥5,200,000                │
│ 限额：¥5,000,000                    │
│ 突破比例：104%                      │
├─────────────────────────────────────┤
│ [减仓50%] [减仓30%] [暂不处理]      │
│ [联系风控负责人]                    │
└─────────────────────────────────────┘
```

### 4. 群机器人消息
```
适用场景：
- 群组广播
- 团队通知
- 自动化日报

特点：
- 发送到指定群组
- 支持@所有人
- 可设置关键词回复

配置步骤：
1. 在飞书群中添加自定义机器人
2. 获取 Webhook 地址
3. 系统调用 Webhook 发送消息
```

## 飞书通知内容设计

### 预警消息模板
```
模板结构：
1. 预警标识（图标+级别）
2. 预警标题
3. 时间戳
4. 关键数据
5. 上下文信息
6. 建议操作
7. 交互按钮

设计原则：
- 一眼可见核心信息
- 重要数据突出显示
- 行动指引清晰
- 颜色区分级别
```

### 级别颜色规范
```
紧急：🔴 红色 #FF0000
重要：🟠 橙色 #FF8C00
一般：🟡 黄色 #FFD700
提示：🔵 蓝色 #1E90FF
成功：🟢 绿色 #32CD32
```

## 飞书通知实现

### API 调用方式
```python
# 飞书消息发送示例
import requests
import json

def send_feishu_alert(webhook_url, title, content, level="normal"):
    """
    发送飞书卡片消息
    """
    # 根据级别设置颜色
    color_map = {
        "critical": "FF0000",
        "major": "FF8C00",
        "minor": "FFD700",
        "info": "1E90FF"
    }
    
    card = {
        "msg_type": "interactive",
        "card": {
            "config": {"wide_screen_mode": True},
            "header": {
                "title": {"tag": "plain_text", "content": title},
                "template": color_map.get(level, "1E90FF")
            },
            "elements": [
                {
                    "tag": "div",
                    "text": {"tag": "lark_md", "content": content}
                }
            ]
        }
    }
    
    response = requests.post(webhook_url, json=card)
    return response.status_code == 200
```

### 通知频率控制
```
防刷屏机制：
1. 冷却时间
   - 同一标的同类预警：30分钟内不重复
   - 紧急预警：无冷却，每次都发

2. 聚合发送
   - 5分钟内同类预警聚合为一条
   - 列表展示多个触发项

3. 升级机制
   - 重要预警未处理：10分钟后@提醒
   - 紧急预警未处理：5分钟后电话跟进
```

## 飞书通知最佳实践

### 1. 精简有效
```
✅ 好的消息：
【紧急】腾讯控股跌破400港元
当前：398.60 | 跌幅：-2.1%
触及止损线，建议关注

❌ 不好的消息：
你的股票有情况，快去看看吧...
（缺乏关键信息）
```

### 2. 可操作
```
每条预警应包含：
- 发生了什么
- 当前状态
- 建议怎么做
- 快速操作入口
```

### 3. 可追溯
```
消息中应包含：
- 精确时间戳
- 触发条件详情
- 唯一标识ID
- 相关链接
```

### 4. 分级可见
```
- 个人预警 → 私信
- 团队通知 → 部门群
- 全员广播 → 大群+@所有人
- 仅管理层 → 管理群
```

## 飞书通知配置清单

```
配置检查：
□ Webhook地址配置正确
□ 签名验证已设置（防篡改）
□ 消息模板已测试
□ 频率限制已配置
□ 异常重试机制已启用
□ 发送日志已记录
□ 接收人权限已验证
```

---
*文档版本：v1.0 | 投资技能学习系列*
