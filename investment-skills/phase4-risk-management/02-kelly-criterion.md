# 2. 凯利公式与最优仓位 (Kelly Criterion & Optimal Position Sizing)

## 概念定义

凯利公式（Kelly Criterion）是由约翰·凯利（John Kelly）于1956年提出的数学公式，用于确定在已知胜率和盈亏比的情况下，每次下注的最优资金比例，以实现长期财富最大化。

## 数学原理

### 基本公式
```
f* = (bp - q) / b

其中：
f* = 最优仓位比例
b = 赔率（盈利金额/亏损金额，即盈亏比）
p = 胜率（盈利概率）
q = 败率 = 1 - p
```

### 推导逻辑
凯利公式基于信息论和对数效用函数，目标是最大化财富增长率的期望值：
```
G = p × log(1 + bf) + q × log(1 - f)
```
对G求导并令其为0，得到最优解f*。

## 计算示例

### 案例1：简单投注
- 胜率 p = 60%
- 赔率 b = 1:1（盈利100元，亏损100元）
- f* = (1 × 0.6 - 0.4) / 1 = 0.2 = 20%

**结论**：每次投入20%资金可实现长期最优增长

### 案例2：股票交易
- 历史胜率 p = 55%
- 平均盈利 b = 2（平均盈利200元，平均亏损100元）
- f* = (2 × 0.55 - 0.45) / 2 = 0.65 / 2 = 32.5%

### 案例3：风险投资
- 胜率 p = 20%（早期投资成功率）
- 赔率 b = 10:1（成功回报10倍，失败亏损全部）
- f* = (10 × 0.2 - 0.8) / 10 = 1.2 / 10 = 12%

## 应用场景

### 适用场景
1. **重复性博弈**：高频交易、赌场游戏、体育博彩
2. **策略回测**：基于历史数据计算理论最优仓位
3. **投资组合配置**：多资产最优权重分配
4. **期权定价**：确定对冲比例

### 不适用场景
- 一次性大额投资
- 胜率/赔率极不确定的情况
- 资金规模受限时

## 实际应用调整

### 分数凯利（Fractional Kelly）
由于实际市场中胜率和赔率难以精确估计，实践中常用**半凯利**或**1/4凯利**：
```
实际仓位 = f* × 0.5  或  f* × 0.25
```

**原因**：
- 参数估计误差缓冲
- 降低波动和最大回撤
- 提高心理舒适度

### 多策略组合
对于k个独立策略，凯利公式扩展为：
```
F = C^(-1) × M

其中：
F = 最优仓位向量
C = 收益率协方差矩阵
M = 超额收益率向量
```

## 注意事项

⚠️ **风险提示**
1. **参数敏感性**：胜率微小变化会导致仓位大幅调整
2. **波动集中**：全凯利仓位波动极大，可能承受50%+回撤
3. **连续亏损**：即使最优仓位，也可能遭遇连续亏损期
4. **市场变化**：历史胜率不代表未来表现

✅ **实践建议**
- 保守估计胜率（使用下限而非点估计）
- 结合风险价值(VaR)限制极端损失
- 定期重新校准参数
- 考虑使用凯利公式的分数版本

## 凯利公式 vs 其他方法

| 方法 | 仓位计算 | 适用场景 | 特点 |
|------|----------|----------|------|
| 凯利公式 | 基于胜率和赔率 | 概率已知 | 数学最优 |
| 固定比例 | 固定百分比 | 通用 | 简单易行 |
| 固定金额 | 固定资金 | 小额账户 | 绝对风险可控 |
| 波动率调整 | 基于ATR/VaR | 趋势跟踪 | 动态适应 |

---
*文档版本：v1.0 | 投资技能学习系列*
