# 2025-02-24

## 学习记录

### 工作流程约定
- 每当学到新的使用技巧或经验，必须做两件事：
  1. 更新到 `OpenClaw_myClaw` 项目
  2. 推送到 GitHub
  3. 同时记录在我的记忆文件（memory/ 和 MEMORY.md）中
  4. 记忆文件也要推送到 GitHub

### 语言偏好
- 用户使用中文，我应该用中文回复

### 记录风格
- 记忆和技能描述要精简准确
- 目的：减少 token 消耗，提高速度

### 工作原则
- 遇到问题先尝试自己解决，不要只反馈问题
- 自主寻找解决方案，自主执行，减少用户负担
- GitHub推送失败时，不要一直重试，本地保存后每小时尝试一次，避免浪费资源

## 方案设计

### 子代理自适应调用策略
根据任务难度和特征自动选择方案分支：

| 分支 | 触发条件 | 核心策略 |
|------|----------|----------|
| Simple | <10s, <2工具 | 不spawn |
| Standard | 10-60s, 独立任务 | run模式+超时 |
| Batch | 3-20个同类任务 | 批量并行 |
| Orchestrator | 有依赖关系 | maxSpawnDepth=2 |
| Deep | >5分钟, 多轮 | session+thread |

详细配置见 `memory/subagent-strategies.md`

### 子代理自适应调度系统
经过10轮迭代优化，整合为完整方案：
- 三层决策器（规则+LLM+试探）
- 加权并发系统
- 分级失败恢复
- 三层成本防护
- 分层上下文管理
- 策略权限系统
- 分布式追踪
- 自适应学习

完整文档：`memory/subagent-adaptive-system.md`

### 新增功能：用户确认提醒
选择非Simple分支时，执行前提醒用户：
- 展示选择的策略（Standard/Batch/Deep等）
- 预估耗时和成本
- 提供选项：[确认执行] [换Simple] [取消]

目的：让用户知情同意，避免意外成本和等待

### 技能实现完成 ✅
已实现并推送子代理调度器技能：
- 路径：`skills/subagent-scheduler/`
- 功能：任务分类、飞书卡片确认、SQLite历史记录、成本预估、失败重试
- 文件：SKILL.md, scheduler.js, database.js, feishu.js, index.js, test.js
- 状态：测试通过，可运行

### 限制绕过方案完成 ✅
通过自主尝试解决以下原有限制：
1. **真实SQLite** - 安装better-sqlite3，实现真实数据库操作
2. **Cron定时轮询** - 使用node-cron实现进度监控和日报
3. **Redis并发控制** - 安装ioredis，实现全局并发控制（支持本地降级）
4. **成本监控** - 基于历史数据训练预估模型，实时监控
5. **失败重试** - 实现指数退避重试机制（最多5次）
6. **飞书回调** - 使用轮询+文字指令方式替代按钮回调
7. **子代理spawn** - 创建适配器模式，主会话传入toolExecutor即可执行

所有代码已推送到 GitHub。
